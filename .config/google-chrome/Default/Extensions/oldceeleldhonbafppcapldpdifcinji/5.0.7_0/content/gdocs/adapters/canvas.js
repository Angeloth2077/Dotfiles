class GoogleDocsCanvas{static isElementCompatible(t){return isGoogleDocsCanvas(t)}static getUnhandledPages(){const t=document.querySelectorAll(".kix-page-paginated");return Array.from(t,(t=>{let e=Array.from(t.querySelectorAll(".kix-canvas-tile-content:not(.kix-canvas-tile-selection):not([data-lt-tweaks])"));return e=e.filter((t=>!!t.querySelector("svg")&&!t.querySelector("clipPath, image"))),e[e.length-1]})).filter(Boolean)}static isPage(t){return t.classList.contains(this.PAGE_CLASS_NAME)}static initPage(t){}static destroyPage(t){}static hasPreviousPage(t){return!t.closest(".canvas-first-page")}static getNextPage(t){let e=t.nextElementSibling;for(;e;){if(this.isPage(e))return e;e=e.nextElementSibling}return null}static getCanvases(t){const e=t.closest(".kix-page-paginated");return e?Array.from(e.querySelectorAll("canvas.kix-canvas-tile-content")):[]}static getPageContainer(t){return t.closest(this.PAGE_CONTAINER_SELECTOR)}static triggerRedraw(){try{const t=new Event("visibilitychange");document.dispatchEvent(t);const e=new Event("webkitvisibilitychange");document.dispatchEvent(e)}catch(t){}}static isMutationIgnored(t,e){return!1}static isIgnoredElement(t){return!1}static isBlockElement(t,e){return!1}static replaceText(t,e,o){return t}static getReplacementText(t){return""}static _lockMousemove(){this._mousemoveCapture||(this._mousemoveCapture=addUseCaptureEvent(document,"mousemove",(t=>t.stopImmediatePropagation())))}static _unlockMousemove(){this._mousemoveCapture&&(this._mousemoveCapture.destroy(),this._mousemoveCapture=null)}static applyFix(t){const{offset:e,length:o,replacementText:s,editor:n}=t,a=n.inputAreaWrapper.getTextRanges(e,o),r=document.querySelector(".kix-appview-editor");if(!r)return Tracker.trackError("other","google_docs:apply_fix1"),Promise.reject();const i=GoogleDocs.getIframeWin();if(!i)return Tracker.trackError("other","google_docs:apply_fix3"),Promise.reject();const c=i.document.querySelector("[contenteditable=true]");if(!c)return Tracker.trackError("other","google_docs:apply_fix4"),Promise.reject();const l=new DomMeasurement(document).getBorderBox(r,!1);let{firstTextBox:u,lastTextBox:g}=this._updateTextBoxes(n.inputArea,a),d=0;u.top<l.top?(r.scrollTop-=l.top-(u.top-35),d=50):g.bottom>l.bottom&&(r.scrollTop+=g.bottom+35-l.bottom,d=50),u.left<l.left?(r.scrollLeft-=l.left-(u.left-35),d=50):g.right>l.right&&(r.scrollLeft+=g.right+35-l.right,d=50);const h=this._updateTextBoxes(n.inputArea,a);u=h.firstTextBox,g=h.lastTextBox;const m=a[0].node.parentElement;if(!m)return Tracker.trackError("other","google_docs:apply_fix5"),Promise.reject();const p=a[a.length-1].node.parentElement;if(!p)return Tracker.trackError("other","google_docs:apply_fix6"),Promise.reject();this._lockMousemove();const v={clientX:Math.round(u.left+2),clientY:Math.round(u.top+u.height/2),bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL};return wait(d).then((()=>{const t={clientX:Math.round(u.left+Math.max(6,u.width/2)),clientY:Math.round(u.top+u.height/2),bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL};return m.dispatchEvent(new MouseEvent("mousedown",Object.assign({},t))),m.dispatchEvent(new MouseEvent("mouseup",Object.assign({},t))),m.dispatchEvent(new MouseEvent("mouseclick",Object.assign({},t))),m.dispatchEvent(new MouseEvent("mousedown",Object.assign({},t))),m.dispatchEvent(new MouseEvent("mouseup",Object.assign({},t))),m.dispatchEvent(new MouseEvent("mouseclick",Object.assign({},t))),wait(0)})).then((()=>(m.dispatchEvent(new MouseEvent("mousedown",Object.assign({},v))),wait(0)))).then((()=>(m.dispatchEvent(new MouseEvent("mouseup",Object.assign({},v))),m.dispatchEvent(new MouseEvent("click",Object.assign({},v))),wait(20)))).then((()=>{this._unlockMousemove();const t={clientX:Math.round(u.left),clientY:Math.round(u.top+u.height/2),bubbles:!0,shftKey:!1,detail:GoogleDocs.MOUSE_EVENT_DETAIL},e={clientX:Math.round(g.right),clientY:Math.round(g.top+g.height/2),bubbles:!0,shftKey:!0,detail:GoogleDocs.MOUSE_EVENT_DETAIL},o={shiftKey:!0,key:"Shift",code:"ShiftLeft",keyCode:16,charCode:0,which:16,location:1};m.dispatchEvent(new MouseEvent("mousedown",t)),p.dispatchEvent(new MouseEvent("mousemove",e)),c.dispatchEvent(new i.KeyboardEvent("keydown",o)),p.dispatchEvent(new MouseEvent("mouseup",e)),c.dispatchEvent(new i.KeyboardEvent("keyup",o));const n=i,a=s.replace(/^\s/," ").replace(/\s$/," ");let r;try{r=new n.ClipboardEvent("paste",{clipboardData:new n.DataTransfer,bubbles:!0}),r.clipboardData.setData("text/plain",a)}catch(t){r=new n.ClipboardEvent("paste",{bubbles:!0})}return c.dispatchEvent(r),c.textContent=a,Promise.resolve()})).finally((()=>this._unlockMousemove()))}static getTextWidth(t,e){const o=this._getCanvasRenderingContextForMeasurement();return o.font=e,o.measureText(t).width}static getRelativeTextBoundingBoxes(t,e){Array.isArray(t)||(t=[t]);const o=[];return t.forEach((t=>{const e=t.node,s=e.getAttribute("aria-label")||"",n=s.substring(0,t.start),a=s.substring(t.start,t.end);if(!a)return;const r=e.getAttribute("data-font-css")||"",i=this.getTextWidth(n,r),c=this.getTextWidth(a,r),[l,u,g,d]=this.getMatrixFromSVGElement(e),h=c*g;if(h<DomMeasurement.MIN_TEXT_BOX_WIDTH)return;const m=parseFloat(e.getAttribute("height")||"0")*d,p=l+parseFloat(e.getAttribute("x")||"0")*g,v=u+parseFloat(e.getAttribute("y")||"0")*d,E=Math.round(p+i*g),f=Math.round(v),x=Math.round(p+(i+c)*g),b=Math.round(v+m);o.push({width:h,height:m,left:E,top:f,right:x,bottom:b})})),o}static getTextBoundingBoxes(t,e){const o=this.getRelativeTextBoundingBoxes(t,e),s=e.getBoundingClientRect();return o.forEach((t=>{t.top+=s.top,t.bottom+=s.top,t.left+=s.left,t.right+=s.left})),o}static _getCanvasRenderingContextForMeasurement(){return this._canvasRenderingContextForMeasurement||(this._canvasForMeasurement=document.createElement("canvas"),this._canvasForMeasurement.style.cssText="position: absolute !important; left: -99999px !important; top: 0 !important; visibility: hidden !important;",document.body.appendChild(this._canvasForMeasurement),this._canvasRenderingContextForMeasurement=this._canvasForMeasurement.getContext("2d")),this._canvasRenderingContextForMeasurement}static getMatrixFromSVGElement(t){const e=(t.getAttribute("transform")||"").match(this.MATRIX_REG_EXP);let o=0,s=0,n=1,a=1;return e&&(o=parseFloat(e[5]),s=parseFloat(e[6]),n=parseFloat(e[1]),a=parseFloat(e[4])),[o,s,n,a]}static _updateTextBoxes(t,e){const o=this.getTextBoundingBoxes(e,t);return{textBoxes:o,firstTextBox:o[0],lastTextBox:o[o.length-1]}}static _getSelectionOffset(t,e,o=!1){const s=t.getBoundingClientRect(),[n,a,r,i]=this.getMatrixFromSVGElement(e),c=parseFloat(e.getAttribute("height")||"0")*i,l=parseFloat(e.getAttribute("width")||"0")*r,u=parseFloat(e.getAttribute("x")||"0")*r+n,g=s.left+u+(o?l:0),d=parseFloat(e.getAttribute("y")||"0")*i+a,h=s.top+d;t.classList.add("lt-gdocs-make-rect-visible");let m=document.elementFromPoint(g+(o?-1:1),h+c/100*30);if(m&&"rect"!==m.nodeName&&(m=document.elementFromPoint(g+(o?-1:1),h+c/100*70)),t.classList.remove("lt-gdocs-make-rect-visible"),!m||"rect"!==m.nodeName)return null;const p=m,[v,,E]=this.getMatrixFromSVGElement(p),f=parseFloat(p.getAttribute("x")||"0")*E+v,x=p.getAttribute("aria-label")||"",b=p.getAttribute("data-font-css")||"";for(let t=0;t<=x.length;t++){if((this.getTextWidth(x.substring(0,t),b)+.5)*r+f>=u)return{node:p,offset:t}}return null}static getSelectionRects(t){const e=this.getPageContainer(t);return e?Array.from(e.querySelectorAll(this.SELECTION_RECT_SELECTOR)):[]}static getSelection(t){const e=this.getSelectionRects(t);if(!e.length)return;const o=this._getSelectionOffset(t,e[0]),s=this._getSelectionOffset(t,e[e.length-1],!0);return o&&s?{startNode:o.node,startOffset:o.offset,endNode:s.node,endOffset:s.offset,isCollapsed:!1}:void 0}static getSelectedText(){const t=GoogleDocs.getIframeWin();if(!t)return;const e=new t.CustomEvent("copy",{bubbles:!0}),o=t.document.querySelector("[contenteditable=true]");return o?(o.dispatchEvent(e),o.innerText):void 0}static destroy(){var t;null===(t=this._canvasForMeasurement)||void 0===t||t.remove(),this._canvasForMeasurement=null}}GoogleDocsCanvas.PAGE_CLASS_NAME="kix-canvas-tile-content",GoogleDocsCanvas.PAGE_CONTAINER_SELECTOR=".kix-page-paginated",GoogleDocsCanvas.SELECTION_RECT_SELECTOR=".kix-canvas-tile-selection svg > rect, .kix-canvas-tile-selection svg > g > rect",GoogleDocsCanvas.MATRIX_REG_EXP=/matrix\(([\-0-9\.]+),\s*([\-0-9\.]+),\s*([\-0-9\.]+),\s*([\-0-9\.]+),\s*([\-0-9\.]+),\s*([\-0-9\.]+)\)/,GoogleDocsCanvas._canvasForMeasurement=null,GoogleDocsCanvas._mousemoveCapture=null,"undefined"!=typeof module&&(module.exports=GoogleDocsCanvas);
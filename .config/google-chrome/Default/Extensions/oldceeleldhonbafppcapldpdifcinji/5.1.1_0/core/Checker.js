/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
var __awaiter=this&&this.__awaiter||function(e,r,t,s){return new(t||(t=Promise))((function(i,a){function E(e){try{o(s.next(e))}catch(e){a(e)}}function n(e){try{o(s.throw(e))}catch(e){a(e)}}function o(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(E,n)}o((s=s.apply(e,r||[])).next())}))};class Checker{static getServerBaseUrl(e,r=!1,t=!0){const s=!!e.customApiServerUrl,i=t&&(r?this._useFallbackServerForParagraphLevelRequests:this._useFallbackServerForTextLevelRequests)&&!e.customApiServerUrl;return s?e.customApiServerUrl:e.isPremium||e.customApiServerUrl===config.PREMIUM_SERVER_URL?i?config.PREMIUM_FALLBACK_SERVER_URL:config.PREMIUM_SERVER_URL:i?config.MAIN_FALLBACK_SERVER_URL:config.MAIN_SERVER_URL}static _getServerFullUrl(e,r=!1,t=!1){let s=this.getServerBaseUrl(e,r);return s+=s.endsWith("/")?"check":"/check",s+="?c=1",r&&!e.useParagraphLevelCaching||(s+=`&instanceId=${encodeURIComponent(e.instanceId)}`),t&&(s+="&languageChanged=true"),e.version&&(s+=`&v=${encodeURIComponent(e.version)}`),s}static _abortCheckRequest(e){this._textLevelAbortControllers.has(e)&&(this._textLevelAbortControllers.get(e).abort(),this._textLevelAbortControllers.delete(e))}static _abortParagraphLevelCheckRequest(e){this._paragraphLevelAbortControllers.has(e)&&(this._paragraphLevelAbortControllers.get(e).abort(),this._paragraphLevelAbortControllers.delete(e))}static _abortLanguageDetectionRequest(e){this._languageDetectionAbortControllers.has(e)&&(this._languageDetectionAbortControllers.get(e).abort(),this._languageDetectionAbortControllers.delete(e))}static _prepareText(e){return e.replace(this.ZWNJ_REGEXP,this.ZWS)}static _joinInChunks(e,r=config.PARAGRAPH_LEVEL_CHUNK_LENGTH){(e=[...e]).sort(((e,r)=>r.text.length-e.text.length));const t=[],s=[];for(const i of e){let e=-1;for(let a=0;a<t.length;a++)s[a]+i.text.length>r||(-1===e||s[e]<s[a])&&(e=a);-1!==e?(t[e].push(i),s[e]+=i.text.length):(t.push([i]),s.push(i.text.length))}return t}static _getRequestData(e,r,t){const s=new URLSearchParams,i={text:e};t.recipientInfo&&(t.recipientInfo.address||t.recipientInfo.fullName)&&(i.metaData={EmailToAddress:t.recipientInfo.address,FullName:t.recipientInfo.fullName}),s.append("data",JSON.stringify(i));const a=Boolean(t.isPremium||t.customApiServerUrl&&t.customApiServerUrl.startsWith(config.PREMIUM_SERVER_URL));if(a&&t.user&&"password"in t.user?(s.append("username",t.user.email),s.append("password",t.user.password)):a&&t.user&&"token"in t.user&&(s.append("username",t.user.email),s.append("tokenV2",t.user.token)),s.append("textSessionId",t.instanceId),t.isPremium||s.append("enableHiddenRules","true"),t.motherTongue&&s.append("motherTongue",t.motherTongue),"normal"!==t.checkLevel&&s.append("level",t.checkLevel.replace("hidden-","")),r)s.append("language",r.code);else{s.append("language","auto"),s.append("noopLanguages",t.preferredLanguages.join(",")),s.append("preferredLanguages",t.preferredLanguages.join(","));const e=this._getPreferredVariants(t.languageVariants.en,t.languageVariants.de,t.languageVariants.pt,t.languageVariants.ca);e.length>0&&s.append("preferredVariants",e.toString())}return s.append("disabledRules","WHITESPACE_RULE,CONSECUTIVE_SPACES"),t.userAgent&&s.append("useragent",t.userAgent),s}static _getPreferredVariants(e,r,t,s){const i=[];return e&&i.push(e),r&&i.push(r),t&&i.push(t),s&&i.push(s),i}static _getCheckRequestData(e,r,t){const s=this._getRequestData(e,r,t);return s.append("mode","textLevelOnly"),s}static _getParagraphLevelCheckRequestData(e,r,t,s){const i=this._getRequestData(e,r,t);return i.append("mode","allButTextLevelOnly"),i.append("allowIncompleteResults",s.toString()),i}static _sendRequest(e,r,t=config.CHECK_REQUEST_TIMEOUT){return __awaiter(this,void 0,void 0,(function*(){const s=fetch(e,r).catch((r=>{throw"AbortError"===r.name?{reason:"AbortError",status:0,response:r.message||""}:{reason:"ConnectionError",status:0,url:e.replace(/\?.*/,""),response:r.message||""}})).then(this._checkForException).then((e=>e.json())),i=new Promise(((r,s)=>{window.setTimeout((()=>{s({reason:"TimeoutError",status:0,url:e.replace(/\?.*/,""),response:""})}),t)}));return Promise.race([s,i])}))}static _isConnectionOrServerIssue(e){return config.SWITCH_TO_FALLBACK_SERVER_ERRORS.includes(e.status)||["ConnectionError","TimeoutError"].includes(e.reason)}static _getGraphemesCount(e,r,t=0){for(let s=t;s<e.length;s++){if(r<=0)return s-t;r-=e[s].length}return e.length-t}static _getCodepointsCount(e,r,t=0){let s=0;for(let i=t;i<Math.min(e.length,t+r);i++)s+=e[i].length;return s}static _correctMatches(e,r,t){if(r!==t){const s=new GraphemeSplitter,i=s.splitGraphemes(r),a=s.splitGraphemes(t);for(const r of e){const e=Checker._getGraphemesCount(i,r.offset),t=Checker._getGraphemesCount(i,r.length,e);r.offset=Checker._getCodepointsCount(a,e),r.length=Checker._getCodepointsCount(a,t,e)}}return e}static _getLeftText(e,r,t,s=15){let i=Math.max(r-s,0);if(t){const t=e.lastIndexOf("\n",r);t>=i&&(i=t+1)}let a=e.substring(i,r);return 0===i||t&&"\n"===e[i-1]||(a="..."+a),a}static _getRightText(e,r,t,s=15){let i=Math.min(r+s,e.length);if(t){const t=e.indexOf("\n",r);-1!==t&&t<=i&&(i=t)}let a=e.substring(r,i);return i===e.length||t&&"\n"===e[i]||(a+="..."),a}static _transformMatches(e,r,t,s=!1){return e.map((e=>{const i=e.rule.id.startsWith("DB_"),a=this.SPELLING_RULES_ID.some((r=>e.rule.id.includes(r))),E=this.STYLE_ISSUE_TYPES.some((r=>e.rule.issueType===r)),n="typographical"===e.rule.issueType&&"CASING"!==e.rule.category.id||"PUNCTUATION"===e.rule.category.id||"TYPOGRAPHY"===e.rule.category.id||e.rule.category.id.includes("KOMMA"),o=Boolean(e.rule.tags&&e.rule.tags.includes("picky")),_=r.substr(e.offset,e.length),l=`${Checker._getLeftText(r,e.offset,s)}|${_}|${Checker._getRightText(r,e.offset+e.length,s)}`,u=Checker._getLeftText(r,e.offset,!0,60),c=Checker._getRightText(r,e.offset+e.length,!0,60),h=`${escapeHTML(u)}<lt-em>${escapeHTML(_)}</lt-em>${escapeHTML(c)}`;let A="";e.shortMessage&&e.shortMessage.length<60&&e.shortMessage!==e.message&&(A=e.shortMessage.replace(this.PUNCTUATION_AT_END,""));const R=e.replacements.map((e=>({value:e.value,prefix:e.prefix,suffix:e.suffix,type:e.type,shortDescription:e.shortDescription})));return{isParagraphLevelCheck:s,rule:e.rule,isCustomError:i,isSpellingError:a,isStyleError:E,isPunctuationError:n,isPicky:o,contextForSureMatch:e.contextForSureMatch,language:{code:t.code,name:t.name},description:e.message,shortDescription:A,start:e.offset,end:e.offset+e.length,length:e.length,originalPhrase:_,contextPhrase:l,longContextPhrase:h,fixes:R}}))}static _adjustErrors(e,r,t){const s=t.recipientInfo?t.recipientInfo.fullName.split(" ").filter((e=>e)):[];return e.filter((e=>{if(t.ignoreCapitalizationErrors){if(e.fixes.some((r=>r.value.toLowerCase()===e.originalPhrase.toLowerCase())))return!1;if("UPPERCASE_SENTENCE_START"===e.rule.id)return!1}e.fixes=e.fixes.filter((r=>r.value!=="("+e.originalPhrase+")"&&r.value!==e.originalPhrase&&"(suggestion limit reached)"!==r.value&&"(se ha alcanzado el límite de sugerencias)"!==r.value&&"(Vorschlagslimit erreicht)"!==r.value)),e.language.code.startsWith("en")&&isAllUppercase(e.originalPhrase)&&!/[a-z]/i.test(e.contextPhrase)&&e.fixes.forEach((r=>{r.value.toLowerCase()!==e.originalPhrase.toLowerCase()&&(r.value=r.value.toUpperCase())})),"PT_CLICHE_REPLACE"!==e.rule.id&&"PT_WORDINESS_REPLACE"!==e.rule.id||e.fixes.forEach((r=>{(r.value.startsWith("REFORMULAR")||r.value.startsWith("APAGAR")||r.value.startsWith("ESPECIFICAR"))&&(e.description=e.description.replace(/\sÉ preferível dizer.+(REFORMULAR|APAGAR|ESPECIFICAR).+$/,""),r.value="")}));if(this.EMAIL_SIGNATURE_SEPARATOR_REGEXP.test(e.originalPhrase))return!1;if(this.ZWS_REGEXP.test(e.originalPhrase))return!1;if(e.rule.id.endsWith("WORD_REPEAT_BEGINNING_RULE")&&this.ONLY_NUMBERS_REGEXP.test(e.originalPhrase))return!1;if("LEERZEICHEN_HINTER_DOPPELPUNKT"===e.rule.id&&this.COLON_WHITESPACE_REGEXP.test(e.originalPhrase))return!1;const i=r.substring(e.start-25,e.start),a=r.substr(e.end,25);if(t.ignoreCapitalizationErrorsAtLineStart&&"UPPERCASE_SENTENCE_START"===e.rule.id&&this.MID_SENTENCE_LINE_BREAK.test(i))return!1;if("DE_CASE"===e.rule.id&&this.BULLET_POINT_REGEXP.test(i))return!1;if("DE_CASE"===e.rule.id&&this.NUMBER_WITH_PARENTHESIS_AT_END_REGEXP.test(i))return!1;if("DE_CASE"===e.rule.id&&this.PIPE_AT_END_REGEXP.test(i))return!1;if("DE_CASE"===e.rule.id&&this.MARKDOWN_HEADLINE_REGEXP.test(i))return!1;if("DE_CASE"===e.rule.id&&this.EMOJI_SENTENCE_START_REGEXP.test(i))return!1;if("PUNKT_ENDE_DIREKTE_REDE"===e.rule.id&&!a.trim())return!1;if("LEERZEICHEN_HINTER_DOPPELPUNKT"===e.rule.id&&this.MARKDOWN_INLINE_FORMAT_AT_BEGINNING_REGEXP.test(a))return!1;if("LEERZEICHEN_HINTER_DOPPELPUNKT"===e.rule.id&&this.WIKI_MARKUP_AT_END_REGEXP.test(i))return!1;if(e.rule.id.endsWith("UNPAIRED_BRACKETS")&&("!"===e.originalPhrase||"?"===e.originalPhrase)&&(i.endsWith("!")||i.endsWith("?")))return!1;if(e.rule.id.endsWith("UNPAIRED_BRACKETS")&&this.ONE_LETTER_AT_END_REGEXP.test(i))return!1;if(e.rule.id.endsWith("UNPAIRED_BRACKETS")&&this.NUMBER_WITH_DOT_AT_END_REGEXP.test(i))return!1;if("SENTENCE_WHITESPACE"===e.rule.id&&i.endsWith("{!"))return!1;if("SENTENCE_WHITESPACE"===e.rule.id&&this.SINGLE_UPPERCASE_LETTER_REGEXP.test(e.originalPhrase)&&this.ABBREVIATION_AT_END_REGEXP.test(i))return!1;if("SENTENCE_WHITESPACE"===e.rule.id&&"net"===e.originalPhrase.toLowerCase())return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&this.NET_AT_BEGINNING_REGEXP.test(a))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&e.originalPhrase.endsWith(")")&&i.endsWith(this.ZWS))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&e.originalPhrase.endsWith(".")&&this.FILE_TYPE_AT_BEGINNING_REGEXP.test(a))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&i.endsWith("(")&&(",)"===e.originalPhrase||".)"===e.originalPhrase))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&i.endsWith("\n")&&[")","}","]","."].includes(e.originalPhrase))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&a.startsWith("/"))return!1;if("COMMA_PARENTHESIS_WHITESPACE"===e.rule.id&&e.originalPhrase.includes(this.ZWS))return!1;if("WORT1_BINDESTRICH_SPACE_WORT2"===e.rule.id&&e.originalPhrase.endsWith(this.ZWS))return!1;if("MULTIPLICATION_SIGN"===e.rule.id&&(this.AT_LEAST_TWO_LETTERS_AT_END_REGEXP.test(i)||!a||this.PUNCTUATION_AT_BEGINNING_REGEXP.test(a)))return!1;if("ZBEDNA_SPACJA_PRZED"===e.rule.id&&e.originalPhrase.includes(this.ZWS))return!1;if("UNLIKELY_OPENING_PUNCTUATION"===e.rule.id&&this.PUNCTUATION_SPACE_AT_END_REGEXP.test(i))return!1;if("WORD_CONTAINS_UNDERSCORE"===e.rule.id&&(!this.LOWERCASE_REGEXP.test(e.originalPhrase)||e.originalPhrase.includes("-")||e.originalPhrase.includes("__")||this.SLASH_AT_END_REGEXP.test(i)||this.SLASH_AT_BEGINNING_REGEXP.test(a)))return!1;if("WORD_CONTAINS_UNDERSCORE"===e.rule.id&&i.endsWith("[")&&a.startsWith("]"))return!1;if("WORD_CONTAINS_UNDERSCORE"===e.rule.id&&this.QUOTE_AT_END_REGEXP.test(i)&&this.QUOTE_AT_BEGINNING_REGEXP.test(a))return!1;if("WORD_CONTAINS_UNDERSCORE"===e.rule.id&&(i.endsWith("=")||i.endsWith("&")||i.endsWith("?")))return!1;if(["APOS_INCORRECT","LOOSE_ACCENTS"].includes(e.rule.id)&&"`"===e.originalPhrase)return!1;if(["_2_AANH_B","TYPOGRAFISCHE_ANFUEHRUNGSZEICHEN"].includes(e.rule.id)&&"``"===e.originalPhrase)return!1;if("PT_WEASELWORD_REPLACE"===e.rule.id&&(e.fixes.length=0),e.isSpellingError||"WORD_CONTAINS_UNDERSCORE"===e.rule.id){const r=e.originalPhrase.charAt(0),E=e.originalPhrase.toLowerCase();if(isErrorIgnoredByDictionary(e,t.dictionary))return!1;if(a.startsWith("_")||i.endsWith("_"))return!1;if(e.originalPhrase.startsWith("$")&&a.startsWith("}")&&i.endsWith("{"))return!1;if(e.originalPhrase.startsWith("$")&&e.originalPhrase.endsWith("$"))return!1;if(this.HTML_ENTITIES.includes(e.originalPhrase)&&i.endsWith("&")||this.HTML_ENTITIES_WITH_AND.includes(e.originalPhrase)||this.HTML_ENTITIES_WITH_AND.includes("&"+e.originalPhrase))return!1;if(this.COMMON_TLDS.some(((e,r)=>E.endsWith("."+e)||this.COMMON_TLD_WITH_DOT_REGEXPS[r].test(a))))return!1;if(this.DOT_WITH_PREFIX_REGEXP.test(i)&&this.COMMON_TLDS.includes(E))return!1;if(this.COMMON_FILE_TYPES.some(((e,r)=>E.endsWith("."+e)||this.COMMON_FILE_TYPE_WITH_DOT_REGEXPS[r].test(a))))return!1;if(this.DOT_WITH_PREFIX_REGEXP.test(i)&&this.COMMON_FILE_TYPES.includes(E))return!1;const n="@"===r||this.MENTION_SYMBOL_AT_BEGINNING_REGEXP.test(i),o="#"===r||this.HASH_SYMBOL_AT_BEGINNING_REGEXP.test(i);if(n||o)return!1;if(s.some((r=>r===e.originalPhrase)))return!1;if(this.WAVY_DASH_REGEXP.test(e.originalPhrase))return!1;for(const r of s)if(r.toLowerCase()===e.originalPhrase.toLowerCase()&&!e.fixes.some((e=>e.value===r))){e.fixes.unshift({value:r});break}}return!0}))}static _processResponse(e,r,t,s,i=!1){e.matches=this._correctMatches(e.matches,r,t);let a=this._transformMatches(e.matches,t,e.language,i);a=this._adjustErrors(a,t,s);let E=[],n=[],o=[];const _=!!s.customApiServerUrl;return!s.isPremium&&!_&&e.language&&e.language.code.startsWith("nl")&&(a=a.filter((e=>!this.NL_PREMIUM_RULES.includes(e.rule.id)||(e.rule.id="HIDDEN_RULE",e.fixes=[],E.push(e),!1)))),!s.isPremium&&!_&&e.language&&e.language.code.startsWith("pl")&&(a=a.filter((e=>!this.PL_PREMIUM_RULES.includes(e.rule.id)||(e.rule.id="HIDDEN_RULE",e.fixes=[],E.push(e),!1)))),s.isPremium&&a.forEach((e=>{this.NL_PREMIUM_RULES.includes(e.rule.id)&&(e.rule.isPremium=!0),this.PL_PREMIUM_RULES.includes(e.rule.id)&&(e.rule.isPremium=!0)})),s.debug&&a.forEach((e=>{e.description=(e.rule.isPremium?"prem:":"")+e.rule.id+"["+(e.rule.subId||"")+"] "+e.description})),e.hiddenMatches&&(E=E.concat(this._transformMatches(e.hiddenMatches,t,e.language,i))),"hidden-picky"===s.checkLevel&&(a=a.filter((e=>!e.isPicky||(o.push(e),!1))),e.hiddenMatches&&(E=E.filter((e=>!e.isPicky||(n.push(e),!1))))),{errors:a,premiumErrors:E,pickyErrors:o,premiumPickyErrors:n}}static _correctErrorOffsets(e,r){const t=[];let s=0;for(const i of e){const e=i.text.length;for(const a of r)if(a.start>=s&&a.end<=s+e){const e=Object.assign({},a);e.start=e.start-s+i.offset,e.end=e.start+e.length,t.push(e)}s+=e+2}return t}static checkTextLevel(e,r,t,s=!1){return __awaiter(this,void 0,void 0,(function*(){if(!(e=this._prepareText(e)).trim()||/^( *\n)* *$/g.test(e))return{language:r,errors:[],premiumErrors:[],pickyErrors:[],premiumPickyErrors:[]};this._abortCheckRequest(t.instanceId),this._textLevelAbortControllers.set(t.instanceId,new AbortController),this._useFallbackServerForTextLevelRequests&&Date.now()-this._mainServerUnavailabilityTimeStamp>=config.MAIN_SERVER_RECHECK_INTERVAL&&(this._useFallbackServerForTextLevelRequests=!1);const i=e.normalize(),a=this._getServerFullUrl(t,!1,s),E={method:"post",mode:"cors",credentials:"omit",body:this._getCheckRequestData(i,r,t),signal:this._textLevelAbortControllers.get(t.instanceId).signal};return this._sendRequest(a,E).then((r=>{const{errors:s,premiumErrors:a,pickyErrors:E,premiumPickyErrors:n}=this._processResponse(r,i,e,t);return{language:{code:r.language.code,name:r.language.name},errors:s,premiumErrors:a,pickyErrors:E,premiumPickyErrors:n}})).catch((s=>{if(this._isConnectionOrServerIssue(s)){this._abortCheckRequest(t.instanceId);if(!t.customApiServerUrl&&!this._useFallbackServerForTextLevelRequests)return this._useFallbackServerForTextLevelRequests=!0,this._mainServerUnavailabilityTimeStamp=Date.now(),this.checkTextLevel(e,r,t)}throw s}))}))}static checkParagraphLevel(e,r,t,s=!1){return __awaiter(this,void 0,void 0,(function*(){e.forEach((e=>{e.text=this._prepareText(e.text)}));if(!e.some((e=>!!e.text.trim())))return{language:r,errors:[],premiumErrors:[],pickyErrors:[],premiumPickyErrors:[],isIncompleteResult:!1};this._abortParagraphLevelCheckRequest(t.instanceId),this._paragraphLevelAbortControllers.set(t.instanceId,new AbortController),this._useFallbackServerForParagraphLevelRequests&&Date.now()-this._mainServerUnavailabilityTimeStamp>=config.MAIN_SERVER_RECHECK_INTERVAL&&(this._useFallbackServerForParagraphLevelRequests=!1);const i=this._getServerFullUrl(t,!0),a=this._joinInChunks(e),E=[];for(const e of a){const a=e.map((e=>e.text)).join("\n\n"),n=a.normalize(),o={method:"post",mode:"cors",credentials:"omit",body:this._getParagraphLevelCheckRequestData(n,r,t,s),signal:this._paragraphLevelAbortControllers.get(t.instanceId).signal},_=this._sendRequest(i,o).then((r=>{const{errors:s,premiumErrors:i,pickyErrors:E,premiumPickyErrors:o}=this._processResponse(r,n,a,t,!0),_=this._correctErrorOffsets(e,s),l=this._correctErrorOffsets(e,i),u=this._correctErrorOffsets(e,E),c=this._correctErrorOffsets(e,o);return{language:{code:r.language.code,name:r.language.name},errors:_,premiumErrors:l,pickyErrors:u,premiumPickyErrors:c,isIncompleteResult:!!r.warnings&&r.warnings.incompleteResults}}));E.push(_)}return Promise.all(E).then((e=>({language:e[0].language,errors:Array.prototype.concat.apply([],e.map((e=>e.errors))),premiumErrors:Array.prototype.concat.apply([],e.map((e=>e.premiumErrors))),premiumPickyErrors:Array.prototype.concat.apply([],e.map((e=>e.premiumPickyErrors))),pickyErrors:Array.prototype.concat.apply([],e.map((e=>e.pickyErrors))),isIncompleteResult:e.some((e=>e.isIncompleteResult))}))).catch((i=>{if(this._isConnectionOrServerIssue(i)){this._abortParagraphLevelCheckRequest(t.instanceId);if(!t.customApiServerUrl&&!this._useFallbackServerForParagraphLevelRequests)return this._useFallbackServerForParagraphLevelRequests=!0,this._mainServerUnavailabilityTimeStamp=Date.now(),this.checkParagraphLevel(e,r,t,s)}throw i}))}))}static detectLanguage(e,r,t){return __awaiter(this,void 0,void 0,(function*(){if(e=this._prepareText(e),r||!e.trim()||/^( *\n)* *$/g.test(e))return{language:r,errors:[],premiumErrors:[],pickyErrors:[],premiumPickyErrors:[]};this._abortLanguageDetectionRequest(t.instanceId),this._languageDetectionAbortControllers.set(t.instanceId,new AbortController),this._useFallbackServerForLanguageDetection&&Date.now()-this._mainServerUnavailabilityTimeStamp>=config.MAIN_SERVER_RECHECK_INTERVAL&&(this._useFallbackServerForLanguageDetection=!1);const s=e.substr(0,1e3).normalize(),i=this._getServerFullUrl(t,!1),a={method:"post",mode:"cors",credentials:"omit",body:this._getCheckRequestData(s,r,t),signal:this._languageDetectionAbortControllers.get(t.instanceId).signal};return this._sendRequest(i,a).then((e=>({language:{code:e.language.code,name:e.language.name},errors:[],premiumErrors:[],premiumPickyErrors:[],pickyErrors:[]}))).catch((s=>{if(this._isConnectionOrServerIssue(s)){this._abortLanguageDetectionRequest(t.instanceId);if(!t.customApiServerUrl&&!this._useFallbackServerForLanguageDetection)return this._useFallbackServerForLanguageDetection=!0,this._mainServerUnavailabilityTimeStamp=Date.now(),this.detectLanguage(e,r,t)}throw s}))}))}static checkForPaidSubscription(e,r,t,s=config.PREMIUM_SERVER_URL){return __awaiter(this,void 0,void 0,(function*(){return new Promise(((i,a)=>{s+=s.endsWith("/")?"check":"/check";const E=new URLSearchParams;E.append("language","en-us"),E.append("data",JSON.stringify({text:"The languagetool testrule 8634756."})),e&&r?(E.append("username",e),E.append("password",r)):e&&t&&(E.append("username",e),E.append("tokenV2",t));const n={method:"post",mode:"cors",credentials:"omit",body:E};this._sendRequest(s,n).then((e=>{const r=e.matches.some((e=>"PREMIUM_FAKE_RULE"===e.rule.id));i(r)})).catch((e=>{403!==e.status?a(e):i(!1)}))}))}))}}Checker.NL_PREMIUM_RULES=["FAAG_VAAG","TOO_LONG_SENTENCE","_2_LEESTEKENS","WEEKEND","CASU_QUO","MOMENTEEL","SLECHTS","LEENWOORDEN","KOMMA_HOOR","RELEVANT","HINTS","CHECKEN","ALLEEN_BE","MACHTE","ECHTER","COMMUNICEREN","DESIGN","SANDAAL_ZANDAAL","N","MIDDELS","INTEGREREN","PRIMAIR","OVERIGENS","BETREFFENDE","AGENDA","ERGO","TEN_BEHOEVE","KOMMA_AANH","TM","IE","TER_ZAKE","SIGNIFICANT","GELIEVE","BEHOREN","NAAR_AANLEIDING_VAN","VAN_PLAN_ZIJN","HEDEN","TEN_DODE","VREEMD_VRZ_HIJ","DES","IMPACT","IMMER","BOVENSTAAND","XXXYJE","DUTCH_WRONG_WORD_IN_CONTEXT","LANCEREN","MET_BEHULP_VAN","PRIORITEIT","UWENTWEGE","CATEGORIE","CRITERIUM","GEMOTIVEERD"],Checker.PL_PREMIUM_RULES=["BOWIEM_ZAS","ZE_Z_SPOL","SPACJA_ZNAK_ROWNOSCI","BRAK_PRZECINKA_GDY","PYTANIE_CO","BRAK_PRZECINKA_JESLI","PRZECINEK_ANI","SKROTOWCE_BEZ_DYWIZU","NIEZGODNOSC_PRZYPADKU_PO_LICZEBNIKU","PODMIOT_ORZECZENIE","ROWNIE_JAK","JAK_I","PRZECINEK_POROWNANIE","WOLACZ_BEZ_PRZECINKA","ODNOSNIE_DO","GENERALNIE","BOWIEM_ZAS_PRZECINEK","WYDAWAC_SIE_BYC","POSIADAC_MIEC","PL_GUILLEMET","ITP_ITD","SPACJA_PROCENT","PO","W_TEMACIE","PL_DWA_WYRAZY","W_NAWIAZANIU_DO","WE_W","POKI_CO","VS","DZIEN_DZISIEJSZY","WIELOKROTNE_WYSTPIENIE_TEGO_SAMEGO_WYRAENIA_PRZYIMKOWEGO","I_LUB","PELNIC_ROLE","OKRES_CZASU","UZNAC_JAKO","EFEKT_KONCOWY","DLATEGO_PONIEWAZ","NA_DZIEN_DZISIEJSZY","DODATKOWO_CO_WIECEJ","OWY_W","DZIEN_JUTRZEJSZY","ADRES_ZAMIESZKANIA","W_CHWILI_OBECNEJ","BYC_ZNAJDOWAC_SIE_W_POSIADANIU","DO_TERAZ","PROTOKOL_Z_CZEGO","PO_NAJMNIEJSZEJ_LINII","POTRAFIACY","zarowno_jak_rowniez","GRAC_FAIR_PLAY","DRUGI_NAJWIEKSZY","COFAC_SIE_DO_TYLU","DZIEN_WCZORAJSZY","NA_PRZESTRZENI","IDENTYCZNY_JAK","ZA_WYJATKIEM","MAPA_DROGOWA","W_PRZECIGU_TYGODNIA_W_CIGU","NAPOTKAC_NA","PRZERWA_KAWOWA","WYSOKA_FREKWENCJA","UBRAC_ZALOZYC","PRZY_UDZIALE","W_SLAD_ZA","WYRAZIC_POPARCIE","W_TYM_WZGLEDZIE","PO_PIERWSZE_PRIMO","DOMYSLEC_SIE","WARTY","IDENTYCZNY_DO","W_DRODZE_WYJATKU","PRZEDKLADAC_WNIOSEK","POD_RZAD","PRZYJAZNY_DLA_UZYTKOWNIKA","NA_WSKUTEK","SWIECIC_SUKCESY","W_WEGRZECH","KONDYCJA_FINANSOWA","RULE_NIEMNIEJ","FORMULA_KREMU","PODDAWAC_W_WATPLIWOSC","OPATRZEC_SIE","ODGRYWAC_ZNACZENIE","INFORMACJE_WRAZLIWE","DO_DZIS_DZIEN","CO_I_RAZ","OKRAGLY_ROK","SZERSZE_INFORMACJE","WYSOKA_FORMA","CZEKAC_ZA","BYNAJMNIEJ","WYWIERAC_PIETNO","DOPATRZEC_SIE","ZLA_RENOMA","W_PELNYM_TEGO","W_KAZDYM_BADZ","KOSZTOWAC_TANIEJ","DYGITALNY"],Checker.SPELLING_RULES_ID=["SPELLER_RULE","MORFOLOGIK_RULE","HUNSPELL","SPELLING_RULE"],Checker.STYLE_ISSUE_TYPES=["style","locale-violation","register"],Checker.EMAIL_SIGNATURE_SEPARATOR_REGEXP=/^[\‐|\-]{2,}|[\‐|\-]{2,}$/,Checker.ONLY_NUMBERS_REGEXP=/^[0-9]+$/,Checker.COLON_WHITESPACE_REGEXP=/^[;:]\s/,Checker.ONE_LETTER_AT_END_REGEXP=/\b[a-z]\.?\s?$/i,Checker.NUMBER_WITH_DOT_AT_END_REGEXP=/\d\.?\s?$/,Checker.NUMBER_WITH_PARENTHESIS_AT_END_REGEXP=/\d\.?\)\s$/,Checker.PUNCTUATION_AT_END=/(\.|\!)$/,Checker.BULLET_POINT_REGEXP=/(\u25b6\ufe0e|\u25BA|\*|-|–|\u2606|\u2605|\u25cf|\u2022|\u25e6|\u27A4|\u2714)\s+$/,Checker.LOWERCASE_REGEXP=/[a-z]/,Checker.DOT_WITH_PREFIX_REGEXP=/\w\.$/,Checker.SLASH_AT_END_REGEXP=/(\/|\\)$/,Checker.AT_LEAST_TWO_LETTERS_AT_END_REGEXP=/[a-z]{2}$/i,Checker.SLASH_AT_BEGINNING_REGEXP=/^(\/|\\)/,Checker.QUOTE_AT_END_REGEXP=/[\"\“\”\„]$/,Checker.QUOTE_AT_BEGINNING_REGEXP=/^[\"\“\”\„]/,Checker.PUNCTUATION_AT_BEGINNING_REGEXP=/^\s?[\.\!\?,:…]/,Checker.PUNCTUATION_SPACE_AT_END_REGEXP=/[\.…\?\!]\s+/,Checker.MARKDOWN_HEADLINE_REGEXP=/^#{1,6}\s/m,Checker.MARKDOWN_INLINE_FORMAT_AT_BEGINNING_REGEXP=/^[\*\~\_\^\+\%\@]/m,Checker.WIKI_MARKUP_AT_END_REGEXP=/\[\[[a-z]+$/,Checker.PIPE_AT_END_REGEXP=/\|\s+$/,Checker.MENTION_SYMBOL_AT_BEGINNING_REGEXP=/@[a-z\.\-]*$/i,Checker.HASH_SYMBOL_AT_BEGINNING_REGEXP=/#[a-z\.\-]*$/i,Checker.EMOJI_SENTENCE_START_REGEXP=/(\.|!|\?|^)\s?(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])\s+/,Checker.ABBREVIATION_AT_END_REGEXP=/(\s|\(|^)[A-Z]\.$/,Checker.NET_AT_BEGINNING_REGEXP=/^net\b/i,Checker.SINGLE_UPPERCASE_LETTER_REGEXP=/^[A-Z]$/,Checker.HTML_ENTITIES=["amp","nbsp","gt","lt","bull","euro","copy","laquo","raquo","hellip","middot"],Checker.HTML_ENTITIES_WITH_AND=Checker.HTML_ENTITIES.map((e=>`&${e}`)),Checker.WAVY_DASH_REGEXP=/^\u3030+$/,Checker.ZWS_REGEXP=/^\uFEFF+$/,Checker.ZWNJ_REGEXP=/\u200B|\u200C/g,Checker.ZWS="\ufeff",Checker.MID_SENTENCE_LINE_BREAK=/[\wáàâóòìíéèùúâôîêûäöüß,\)][\u0020\u00A0\uFEFF]*\n\n\n?[\u0020\u00A0\uFEFF]*$/,Checker.COMMON_TLDS=["com","co","org","net","de","info","biz","es","fr","be","in","gov","nl","ca","com.br","br","at","us","au","ru","pl","ly","it","cat","edu","jp","ko","cn","se","no","mil","ch","dk","com.mx","mx","eu","co.uk","uk","ir","cz","ua","kr","gr","tw","nz","co.nz","za","ro","vn","io","tr","me","fi","tv","xyz","pt","ie","app"],Checker.COMMON_TLD_WITH_DOT_REGEXPS=Checker.COMMON_TLDS.map((e=>new RegExp(`^\\.${e.replace(".","\\.")}\\b`,"i"))),Checker.COMMON_FILE_TYPES=["jpeg","jpg","gif","png","bmp","svg","ai","sketch","ico","ps","psd","tiff","tif","mp3","wav","midi","mid","aif","mpa","ogg","wma","wpl","cda","7z","arj","deb","pkg","plist","rar","rpm","tar.gz","tar","zip","bin","dmg","iso","toast","vcd","csv","dat","db","log","mdb","sav","sql","xml","apk","bat","bin","cgi","com","exe","gadget","jar","py","js","jsx","json","wsf","ts","tsx","fnt","fon","otf","ttf","woff","woff2","rb","java","php","html","asp","aspx","cer","cfm","cgi","pl","css","scss","htm","jsp","part","rss","xhtml","key","odp","pps","ppt","pptx","class","cpp","cs","h","sh","swift","vb","ods","odt","xlr","xls","xlsx","xlt","xltx","bak","cab","cfg","cpl","cur","dll","dmp","msi","ini","tmp","3g2","3gp","avi","flv","h264","m4v","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv","doc","docx","dot","dotx","pdf","rtf","srx","text","tex","wks","wps","wpd","txt","yaml","yml","csl","md","adm"],Checker.COMMON_FILE_TYPE_WITH_DOT_REGEXPS=Checker.COMMON_FILE_TYPES.map((e=>new RegExp(`^[\\wáàâóòìíéèùúâôîêûäöüß\\-\\.\\(\\)]*?\\.${e}\\b`,"i"))),Checker.FILE_TYPE_AT_BEGINNING_REGEXP=new RegExp(`(${Checker.COMMON_FILE_TYPES.join("|")})\b`,"i"),Checker._textLevelAbortControllers=new Map,Checker._paragraphLevelAbortControllers=new Map,Checker._languageDetectionAbortControllers=new Map,Checker._useFallbackServerForTextLevelRequests=!1,Checker._useFallbackServerForParagraphLevelRequests=!1,Checker._useFallbackServerForLanguageDetection=!1,Checker._mainServerUnavailabilityTimeStamp=0,Checker._checkForException=e=>e.ok?e:e.text().catch((()=>"")).then((r=>{const t=r.toLowerCase();if(t.includes("too many error"))throw{reason:"TooManyErrors",status:e.status,response:r};if(413===e.status||t.includes("text exceeds the limit"))throw{reason:"TextTooLong",status:e.status,response:r};if(r.toLowerCase().includes("checking took longer than"))throw{reason:"TimeoutError",status:e.status,url:e.url?e.url.replace(/\?.*/,"?..."):"unknown",response:r};if(429===e.status)throw{reason:"TooManyRequests",status:e.status,response:r};if(403===e.status){if(t.includes("client request size limit")||t.includes("client request limit")||t.includes("ip request limit")||t.includes("ip request size limit"))throw{reason:"TooManyRequests",status:e.status,response:r};if(t.includes("authexception"))throw{reason:"InvalidCredentials",status:e.status,response:r};throw{reason:"AccessDenied",status:e.status,response:r}}if(t.includes("checking took longer than"))throw{reason:"TimeoutError",status:e.status,url:e.url?e.url.replace(/\?.*/,"?..."):"unknown",response:r};throw{reason:"UnknownError",status:e.status,response:r}}));
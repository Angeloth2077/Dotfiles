/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class SVGElementWrapper extends InputAreaWrapper{constructor(t,e,s=Number.MAX_SAFE_INTEGER){super(t,e,s),this._paragraphs=[],this.BULLET_POINT_REG_EXP=/^([\u25CF\u25CB\u25C6\u27A2\u25A0\u25A1\u2605\u274F\u2794\u21B5\u2756\u25AA\u2751\u2022\-\–\—o]|[VIX]+\.|[a-z0-9]{1,3}\.|\d{1,2}\.?\)|\d{1,2}\.\d{1,2}\.|\d{1,2}\.\d{1,2}\.\d{1,2}\.|[a-z]{1,2}\.?\)|[A-Z]{1,2}\.?\)|[A-Z]\.)$/,this.FOOTNOTE_NUMBER_REGEXP=/^\d{1,2}$/,this.WHITE_SPACE_REG_EXP=/\s/,this.URL_FRAGMENT_REG_EXP=/[a-z0-9]=\!?[a-z0-9]|[a-z0-9\.]{2,}\![a-z0-9\.]{2,}|[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}[\-_][a-z0-9]{5,}|^\/.+?\/[^\s]+|^\-[a-z\-\/]+\/$|^[A-Za-z0-9]+_[A-Za-z0-9]+\/[A-Za-z0-9_]+$/i,this.FOOTNOTE_NUMBER_FONT_SIZES=[6,7,8,9],this.FONT_STYLE_REGEXP=/(italic\s+|oblique\s+|normal\s+)?(.+?)\s+(.+?)\s+"(.+)"/,this.PAGE_NUMBER_REGEXP=/^\d{1,3}$/,this.PUNCTUATION_REG_EXP=/^[\.!\?,;\:…"”“'’‘]/,this._onMutation=t=>{t.forEach((t=>{t.removedNodes.length&&t.removedNodes.forEach((t=>{"g"===t.nodeName?this._removeParagraph(t):"rect"===t.nodeName&&this._removeParagraphWithRect(t)})),t.addedNodes.length&&t.addedNodes.forEach((t=>{"g"===t.nodeName?this._addParagraph(t):"rect"===t.nodeName&&t.parentNode&&this._addParagraph(t.parentNode)}))})),this._onInput()},this._onDblClick=t=>{const e=removeZWC(this._tweaks.getSelectedText()),s=this.getSelection();if(!e||!s)return;const r={inputAreaWrapper:this,selectedText:e,selection:s,clickedRectangles:GoogleDocsCanvas.getSelectionRects(this._inputArea).map((t=>{const e=t.getBoundingClientRect();return{top:e.top,right:e.right,bottom:e.bottom,left:e.left,width:e.width,height:e.height}}))};dispatchCustomEvent(document,InputAreaWrapper.eventNames.dblclick,r)},this._pageContainer=GoogleDocsCanvas.getPageContainer(t),Array.from(this._inputArea.getElementsByTagName("g"),(t=>{this._addParagraph(t)})),this._updateText(),this._inputArea.addEventListener("dblclick",this._onDblClick),this._inputAreaObserver=this._tweaks.createMutationObserver(this._onMutation),this._inputAreaObserver.observe(this._inputArea,SVGElementWrapper.INPUT_AREA_OBSERVER_CONFIG)}_hasSpaceBefore(t){if(t<=0)return!1;const e=this.getTextRanges(t-1,1)[0];if(!e)return!1;const s=e.node.getAttribute("aria-label");return Boolean(s&&CEElementWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(s.substring(e.start,e.end)))}_hasSpaceAfter(t){const e=this.getTextRanges(t,1)[0];if(!e)return!1;const s=e.node.getAttribute("aria-label");return Boolean(s&&CEElementWrapper.VISIBLE_WHITE_SPACE_REGEXP.test(s.substring(e.start,e.end)))}_offsetInRawText(t,e,s){s=Math.min(t.length,s);let r=0,a=0;do{const n=t[r],i=e[a];if(n===i)a++;else if(isWhiteSpace(n)||"\n"===n)" "===i&&a++;else if("\ufeff"===i)a++;else if(!isZWC(n))break;if(a>s)break;r++}while(r<t.length);return r}_offsetInParsedText(t,e,s){let r=0,a=0;for(;r<s;){const s=t[r],n=e[a];if(s===n)a++;else if(isWhiteSpace(s)||"\n"===s)" "===n&&a++;else if(!isZWC(s))break;r++}return a}_getCanvasElements(){return this._pageContainer?Array.from(this._pageContainer.querySelectorAll("canvas.kix-canvas-tile-content")):[]}_getStrikethroughPoints(){const t=[];return this._getCanvasElements().forEach((e=>{const s=GoogleDocs.getStrikethroughs(e);if(s.length){const r=(parseFloat(e.style.top)||0)+(parseFloat(e.style.marginTop)||0),a=(parseFloat(e.style.left)||0)+(parseFloat(e.style.marginLeft)||0);s.forEach((e=>{t.push({top:e.top+r,left:e.left+a,bottom:e.bottom+r,right:e.right+a})}))}})),t}_updateText(){const t=[];let e=0,s=0;const r=this._getStrikethroughPoints();for(const a of this._paragraphs){const n=a.children[a.children.length-1];let i=null,o=!1;for(let h=0;h<a.children.length;h++){const l=a.children[h],_=l===n;let c=l.text;const d=0===h;if(d&&this.BULLET_POINT_REG_EXP.test(c))continue;const p=a.children[h+1],g=l.font.match(this.FONT_STYLE_REGEXP);if(!g)continue;let[,,u]=g;const E=function(){if(p){Math.abs(l.x+l.width-p.x)>.3&&(o=!0)}if(i=l.x+l.width,_&&t.length){const r=t[t.length-1];r.rawText+="\n\n",r.parsedText+="\n\n",e+=2,s+=2}};if(d&&p&&c.length<3&&this.FOOTNOTE_NUMBER_REGEXP.test(c)&&this.FOOTNOTE_NUMBER_FONT_SIZES.includes(parseInt(u))){E();continue}if(i===l.x&&c.length<3&&this.FOOTNOTE_NUMBER_REGEXP.test(c)&&this.FOOTNOTE_NUMBER_FONT_SIZES.includes(parseInt(u))){E();continue}const[f,T,x,m]=l.matrix;if(r.length){const t=Math.round(f+(l.x+l.width)*x),e=Math.round(T+(l.y+l.height/2)*m);if(r.some((s=>Math.abs(t-s.left)<2&&Math.abs(e-s.top)<3))){E();continue}}if(!p&&null!==i&&l.x-i>100&&c.length<4&&this.PAGE_NUMBER_REGEXP.test(c)){E();continue}if(o&&(o=!1,t.length&&!this.PUNCTUATION_REG_EXP.test(c))){t[t.length-1].rawText.endsWith(" ")||(t[t.length-1].rawText+=" ",t[t.length-1].parsedText+=" ",s++)}const A=this._getParsedText(c);t.push({node:l.element,parsedText:A,rawText:c,isTextNode:!0,parsedTextOffset:s,rawTextOffset:e}),e+=c.length,s+=A.length,E()}}let a="";for(const e of t)a+=e.parsedText;const n=this._text!==a;return this._text=a,this._textChunks=t,n}_getParsedText(t){let e=removeZWC(t);e=normalizeWhiteSpaces(e);const s=t.trim();return!this.WHITE_SPACE_REG_EXP.test(s)&&this.URL_FRAGMENT_REG_EXP.test(e)?"\ufeff".repeat(e.length):e}_getTextOffset(t,e){const s=this._textChunks.find((e=>e.node===t));return s?s.parsedTextOffset+this._offsetInParsedText(s.rawText,s.parsedText,e):-1}getTextBoxes(t,e){return[]}resetText(){}replaceText(t,e,s){return Promise.resolve()}getSelection(){const t=this._tweaks.getSelection();if(!t||!t.startNode)return null;if(!this._inputArea.contains(t.startNode))return null;const e=this._getTextOffset(t.startNode,t.startOffset);return{start:e,end:t.isCollapsed||!t.endNode?e:this._getTextOffset(t.endNode,t.endOffset)}}setSelection(t){}scrollToText(t,e,s=300,r="nearest",a){if(t<0)return;const n=this.getTextRanges(t,e);n.length&&n[0].node instanceof Element&&(n[0].node.scrollIntoView({behavior:"smooth",block:r}),a&&window.setTimeout(a,500))}_generateTextItem(t){return"rect"!==t.nodeName?null:{element:t,text:t.getAttribute("aria-label")||"",font:t.getAttribute("data-font-css")||"",x:parseFloat(t.getAttribute("x")||"0"),y:parseFloat(t.getAttribute("y")||"0"),width:parseFloat(t.getAttribute("width")||"0"),height:parseFloat(t.getAttribute("height")||"0"),matrix:GoogleDocsCanvas.getMatrixFromSVGElement(t)}}_childAlreadyExists(t,e){return t.some((t=>t.x===e.x&&t.y===e.y&&t.text===e.text&&t.font===e.font&&t.matrix.join(",")===e.matrix.join(",")))}_generateParagraphItem(t){const e=[];for(const s of Array.from(t.children)){const t=this._generateTextItem(s);t&&!this._childAlreadyExists(e,t)&&e.push(t)}return e[0]?{element:t,children:e,x:e[0].matrix[0],y:e[0].matrix[1]}:null}_addParagraph(t){if(this._paragraphs.some((e=>e.element===t)))return;const e=this._generateParagraphItem(t);if(e){for(let t=0;t<this._paragraphs.length;t++){const s=this._paragraphs[t];if(e.y<s.y)return void this._paragraphs.splice(t,0,e);if(e.y===s.y&&e.x<s.x)return void this._paragraphs.splice(t,0,e)}this._paragraphs.push(e)}}_removeParagraph(t){const e=this._paragraphs.findIndex((e=>e.element===t));e>-1&&this._paragraphs.splice(e,1)}_removeParagraphWithRect(t){const e=this._paragraphs.findIndex((e=>e.children.find((e=>e.element===t))));e>-1&&this._paragraphs.splice(e,1)}destroy(){this._inputArea.removeEventListener("dblclick",this._onDblClick),this._inputAreaObserver&&this._inputAreaObserver.disconnect()}}SVGElementWrapper.INPUT_AREA_OBSERVER_CONFIG={subtree:!0,childList:!0,attributes:!0,characterData:!1};
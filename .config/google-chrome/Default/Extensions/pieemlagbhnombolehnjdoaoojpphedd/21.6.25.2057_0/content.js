(()=>{"use strict";var e={704:e=>{const t=Symbol("null");let s=0;e.exports=class extends Map{constructor(){super(),this._objectHashes=new WeakMap,this._symbolHashes=new Map,this._publicKeys=new Map;const[e]=arguments;if(null!=e){if("function"!=typeof e[Symbol.iterator])throw new TypeError(typeof e+" is not iterable (cannot read property Symbol(Symbol.iterator))");for(const[t,s]of e)this.set(t,s)}}_getPublicKeys(e,t=!1){if(!Array.isArray(e))throw new TypeError("The keys parameter must be an array");const s=this._getPrivateKey(e,t);let o;return s&&this._publicKeys.has(s)?o=this._publicKeys.get(s):t&&(o=[...e],this._publicKeys.set(s,o)),{privateKey:s,publicKey:o}}_getPrivateKey(e,o=!1){const n=[];for(let r of e){null===r&&(r=t);const e="object"==typeof r||"function"==typeof r?"_objectHashes":"symbol"==typeof r&&"_symbolHashes";if(e)if(this[e].has(r))n.push(this[e].get(r));else{if(!o)return!1;{const t=`@@mkm-ref-${s++}@@`;this[e].set(r,t),n.push(t)}}else n.push(r)}return JSON.stringify(n)}set(e,t){const{publicKey:s}=this._getPublicKeys(e,!0);return super.set(s,t)}get(e){const{publicKey:t}=this._getPublicKeys(e);return super.get(t)}has(e){const{publicKey:t}=this._getPublicKeys(e);return super.has(t)}delete(e){const{publicKey:t,privateKey:s}=this._getPublicKeys(e);return Boolean(t&&super.delete(t)&&this._publicKeys.delete(s))}clear(){super.clear(),this._symbolHashes.clear(),this._publicKeys.clear()}get[Symbol.toStringTag](){return"ManyKeysMap"}get size(){return super.size}}}},t={};function s(o){var n=t[o];if(void 0!==n)return n.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,s),r.exports}(()=>{const e=new(s(704));function t(t,{target:s=document,stopOnDomReady:o=!0,waitForChildren:n=!0,timeout:r=Number.POSITIVE_INFINITY}={}){const i=[t,o,r,n,s],a=e.get(i);if(a)return a;let c;const l=function(){const e={};return e.promise=new Promise(((t,s)=>{e.resolve=t,e.reject=s})),e}(),{promise:u}=l;e.set(i,u);const p=t=>{cancelAnimationFrame(c),e.delete(i,u),l.resolve(t)};return r!==Number.POSITIVE_INFINITY&&setTimeout(p,r),function e(){const r=s.querySelector(t);if((e=>["interactive","complete"].includes((e.ownerDocument||e).readyState))(s)&&(o||r))return void p(r||void 0);let i=r;for(;i;){if(!n||i.nextSibling)return void p(r);i=i.parentElement}c=requestAnimationFrame(e)}(),Object.assign(u,{stop:()=>p()})}const o=[".adSkipButton.skippable",".skipElement",".nextUpCard",".atvwebplayersdk-skipelement-button",".atvwebplayersdk-nextupcard-wrapper"];function n(){const e=function(){for(const e of o){const t=document.querySelector(e);if(t)return t}}();e?(e.click(),console.log("[RPV] Simulated click on skip button!",e)):console.log("[RPV] No skip button found!")}function r(e){const t=new URL(e);return t.search=function(e){const t=new URLSearchParams(e);return t.delete("ref"),t.delete("ref_"),t.delete("keywords"),t.delete("qid"),t.delete("refinements"),t.delete("rnid"),t.delete("sr"),t.delete("s"),t.toString()}(t.search),t.pathname=t.pathname.split("/").filter((e=>!e.startsWith("ref="))).join("/"),t.toString()}class i{constructor(e){this.storageName=e,this.changeListeners=new Set,this.storageName=e}async setup(e){await this.applyConfig(e),browser.storage.onChanged.addListener(((e,t)=>{if("sync"!==t||!e[this.storageName])return;const s=e[this.storageName].newValue;for(const e of this.changeListeners)e(s);this.cache=s}));for(const e of this.changeListeners)e(this.cache)}async getAll(){return(await browser.storage.sync.get(this.storageName))[this.storageName]}async setAll(e){await browser.storage.sync.set({[this.storageName]:e}),this.cache=e}onChange(e){this.changeListeners.add(e),this.cache&&e(this.cache)}async applyConfig(e){const t={...e.defaults,...await this.getAll()};for(const s of e.migrations)s(t,e.defaults);console.info("[RPV] Loaded settings:",t),await this.setAll(t)}}i.migrations={removeUnused(e,t){for(const s of Object.keys(e))s in t||delete e[s]}};const a=new i("settings");a.setup({defaults:{showSpoilers:"onHover",region:null,uid:null},migrations:[i.migrations.removeUnused,e=>{e.uid||(e.uid=Math.random().toString(36).substr(2,9))}]});const c=a;function l(e){const t=!!e.querySelector('[role="progressbar"]');return e.classList.toggle("rpv-watched",t)}function u(e){const t=e.querySelectorAll(".js-node-episode-container");for(const e of t)l(e);console.log("[RPV] Updated watched episodes.")}function p(){window.addEventListener("keydown",(({code:e})=>{"KeyS"===e&&n()})),function(){const e=location.href,t=r(location.href);e!==t&&(history.replaceState(null,"",t),console.groupCollapsed("[RPV] Cleaned up page URL."),console.info(`Before: ${e}`),console.info(`After:  ${t}`),console.groupEnd())}(),async function(){const e=await t(".DVWebNode-detail-btf-wrapper");e&&(u(e),new MutationObserver((()=>{u(e)})).observe(e,{childList:!0,subtree:!0}),c.onChange((({showSpoilers:t})=>{e.dataset.rpvSpoilers=t})))}(),location.origin.endsWith("primevideo.com")||document.querySelector(".av-retail-m-nav-container")&&(document.documentElement.classList.add("rpv-inav"),console.info("[RPV] Enabled improved navigation."))}!async function(){if(!location.origin.endsWith("primevideo.com")){if(!await t([".av-retail-m-nav-container",'[data-category="instant-video"]'].join()))return}p(),async function(e,t){await browser.runtime.sendMessage({event:{type:e,data:t}})}("load-page",{domain:location.hostname})}()})()})();